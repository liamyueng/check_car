<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËΩ¶ËæÜÁéØÂ¢ÉÂÅ•Â∫∑Ê£ÄÊü•</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
        }
        
        h1 {
            font-size: 2rem;
            color: #00d4ff;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #888;
            font-size: 0.9rem;
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .shortcuts {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .shortcut-btn {
            padding: 8px 16px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .shortcut-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.5);
        }
        
        .shortcut-btn.active {
            background: #00d4ff;
            color: #1a1a2e;
        }
        
        .check-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .check-btn.primary {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: #fff;
        }
        
        .check-btn.primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }
        
        .check-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.checking {
            background: #ffa500;
        }
        
        .status-dot.success {
            background: #00ff88;
            animation: none;
        }
        
        .status-dot.fail {
            background: #ff4444;
            animation: none;
        }
        
        .status-dot.idle {
            background: #666;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .results-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .results-title {
            font-size: 1.2rem;
            color: #fff;
        }
        
        .results-summary {
            display: flex;
            gap: 20px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .summary-value.success {
            color: #00ff88;
        }
        
        .summary-value.fail {
            color: #ff4444;
        }
        
        .summary-label {
            font-size: 0.8rem;
            color: #888;
        }
        
        .result-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .result-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }
        
        .result-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .result-item.ok {
            border-left-color: #00ff88;
        }
        
        .result-item.fail {
            border-left-color: #ff4444;
        }
        
        .result-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 14px;
        }
        
        .result-icon.ok {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .result-icon.fail {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
        
        .result-content {
            flex: 1;
        }
        
        .result-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .result-message {
            font-size: 0.85rem;
            color: #888;
        }
        
        .result-message.fail {
            color: #ff8888;
        }
        
        .result-id {
            font-size: 0.8rem;
            color: #666;
            width: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 212, 255, 0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .final-result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .final-result.success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: #00ff88;
        }
        
        .final-result.fail {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: #ff4444;
        }
        
        .duration {
            font-size: 0.9rem;
            color: #888;
            margin-top: 5px;
            font-weight: normal;
        }
        
        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: #ff8888;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .retry-btn {
            padding: 6px 14px;
            border: 1px solid rgba(255, 165, 0, 0.5);
            background: rgba(255, 165, 0, 0.15);
            color: #ffa500;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .retry-btn:hover:not(:disabled) {
            background: rgba(255, 165, 0, 0.25);
            border-color: rgba(255, 165, 0, 0.7);
        }
        
        .retry-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .shortcuts {
                justify-content: center;
            }
            
            .results-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .result-item {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <header>
                <h1>üöó ËΩ¶ËæÜÁéØÂ¢ÉÂÅ•Â∫∑Ê£ÄÊü•</h1>
                <p class="subtitle">ÈááÈõÜÈ©æÈ©∂Êï∞ÊçÆÂâçÁöÑÁéØÂ¢ÉÊ£ÄÊµãÂ∑•ÂÖ∑</p>
            </header>
            
            <div class="control-panel">
                <div class="shortcuts">
                    <button 
                        v-for="shortcut in shortcuts" 
                        :key="shortcut.key"
                        class="shortcut-btn"
                        :class="{ active: selectedItems === shortcut.key }"
                        @click="selectShortcut(shortcut.key)"
                    >
                        {{ shortcut.name }}
                    </button>
                </div>
                
                <button 
                    class="check-btn primary" 
                    @click="runCheck"
                    :disabled="isChecking"
                >
                    {{ isChecking ? 'Ê£ÄÊµã‰∏≠...' : 'ÂºÄÂßãÊ£ÄÊµã' }}
                </button>
            </div>
            
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot" :class="statusClass"></div>
                    <span>{{ statusText }}</span>
                </div>
                <div v-if="lastCheckTime">
                    ‰∏äÊ¨°Ê£ÄÊµã: {{ formatTime(lastCheckTime) }}
                </div>
            </div>
            
            <div class="results-panel">
                <div v-if="isChecking" class="loading">
                    <div class="loading-spinner"></div>
                    <p>Ê≠£Âú®Ê£ÄÊµã‰∏≠ÔºåËØ∑Á®çÂÄô...</p>
                    <p style="font-size: 0.85rem; margin-top: 10px;">È¢ÑËÆ°ÈúÄË¶Å 30-60 Áßí</p>
                </div>
                
                <div v-else-if="!result" class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <p>ÁÇπÂáª‰∏äÊñπÊåâÈíÆÂºÄÂßãÊ£ÄÊµã</p>
                </div>
                
                <template v-else>
                    <div class="results-header">
                        <div class="results-title">Ê£ÄÊµãÁªìÊûú</div>
                        <div class="results-summary">
                            <div class="summary-item">
                                <div class="summary-value success">{{ passedCount }}</div>
                                <div class="summary-label">ÈÄöËøá</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value fail">{{ failedCount }}</div>
                                <div class="summary-label">Â§±Ë¥•</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Â§±Ë¥•È°π -->
                    <div v-if="failedItems.length > 0" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="color: #ff4444; font-weight: bold;">‚ùå Â§±Ë¥•È°π</div>
                            <button 
                                class="retry-btn" 
                                @click="retryFailed"
                                :disabled="isChecking"
                            >
                                üîÑ Âè™Ê£ÄÊµãÂ§±Ë¥•È°π
                            </button>
                        </div>
                        <div class="result-list">
                            <div 
                                v-for="item in failedItems" 
                                :key="item.id"
                                class="result-item fail"
                            >
                                <div class="result-id">#{{ item.id }}</div>
                                <div class="result-icon fail">‚úó</div>
                                <div class="result-content">
                                    <div class="result-name">{{ item.name }}</div>
                                    <div class="result-message fail" v-if="item.message">
                                        {{ item.message }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÊàêÂäüÈ°π -->
                    <div v-if="passedItems.length > 0">
                        <div style="color: #00ff88; font-weight: bold; margin-bottom: 10px;">‚úÖ ÈÄöËøáÈ°π</div>
                        <div class="result-list">
                            <div 
                                v-for="item in passedItems" 
                                :key="item.id"
                                class="result-item ok"
                            >
                                <div class="result-id">#{{ item.id }}</div>
                                <div class="result-icon ok">‚úì</div>
                                <div class="result-content">
                                    <div class="result-name">{{ item.name }}</div>
                                    <div class="result-message" v-if="item.message">
                                        {{ item.message }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="final-result" :class="result.success ? 'success' : 'fail'">
                        <div v-if="result.success">
                            ‚úÖ ËΩ¶ËæÜÊ≠£Â∏∏ÔºåÂèØ‰ª•Ê≠£Â∏∏ÈááÈõÜÈ©æÈ©∂‰ø°ÊÅØ
                        </div>
                        <div v-else>
                            ‚ùå Â≠òÂú®ÂºÇÂ∏∏ÔºåËØ∑Ê†πÊçÆÊèêÁ§∫Â§ÑÁêÜ
                        </div>
                        <div class="duration" v-if="result.duration_seconds">
                            Ê£ÄÊµãËÄóÊó∂: {{ result.duration_seconds.toFixed(1) }} Áßí
                        </div>
                    </div>
                </template>
                
                <div v-if="error" class="error-message">
                    ‚ö†Ô∏è {{ error }}
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const { createApp, ref, computed } = Vue;
        
        createApp({
            setup() {
                const isChecking = ref(false);
                const result = ref(null);
                const error = ref(null);
                const lastCheckTime = ref(null);
                const selectedItems = ref('all');
                
                const shortcuts = [
                    { key: 'all', name: 'ÂÖ®ÈáèÊ£ÄÊµã' },
                    { key: 'car', name: '‰ªÖËΩ¶Êú∫' },
                    { key: 'mount', name: '‰ªÖÊåÇËΩΩ' },
                    { key: 'topic', name: '‰ªÖTopic' },
                    { key: 'mdc1', name: 'MDC1Áõ∏ÂÖ≥' },
                    { key: 'mdc2', name: 'MDC2Áõ∏ÂÖ≥' },
                ];
                
                const statusClass = computed(() => {
                    if (isChecking.value) return 'checking';
                    if (!result.value) return 'idle';
                    return result.value.success ? 'success' : 'fail';
                });
                
                const statusText = computed(() => {
                    if (isChecking.value) return 'Ê£ÄÊµã‰∏≠...';
                    if (!result.value) return 'Á≠âÂæÖÊ£ÄÊµã';
                    return result.value.success ? 'Ê£ÄÊµãÈÄöËøá' : 'Â≠òÂú®ÂºÇÂ∏∏';
                });
                
                const passedCount = computed(() => {
                    if (!result.value || !result.value.passed) return 0;
                    return Object.keys(result.value.passed).length;
                });
                
                const failedCount = computed(() => {
                    if (!result.value || !result.value.failed) return 0;
                    return Object.keys(result.value.failed).length;
                });
                
                // Â∞Ü passed/failed ÂØπË±°ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÂπ∂Êåâ ID ÊéíÂ∫è
                const passedItems = computed(() => {
                    if (!result.value || !result.value.passed) return [];
                    return Object.entries(result.value.passed)
                        .map(([id, item]) => ({ id: parseInt(id), ...item }))
                        .sort((a, b) => a.id - b.id);
                });
                
                const failedItems = computed(() => {
                    if (!result.value || !result.value.failed) return [];
                    return Object.entries(result.value.failed)
                        .map(([id, item]) => ({ id: parseInt(id), ...item }))
                        .sort((a, b) => a.id - b.id);
                });
                
                const selectShortcut = (key) => {
                    selectedItems.value = key;
                };
                
                const runCheck = async (itemsOverride = null) => {
                    isChecking.value = true;
                    error.value = null;
                    
                    try {
                        let items;
                        if (itemsOverride !== null) {
                            items = itemsOverride;
                        } else {
                            items = selectedItems.value === 'all' ? '' : selectedItems.value;
                        }
                        const response = await fetch('/api/check', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ items }),
                        });
                        
                        const data = await response.json();
                        
                        if (data.error && !data.passed && !data.failed) {
                            error.value = data.error;
                        } else {
                            result.value = data;
                            lastCheckTime.value = data.timestamp || new Date().toISOString();
                        }
                    } catch (e) {
                        error.value = 'ÁΩëÁªúÈîôËØØ: ' + e.message;
                    } finally {
                        isChecking.value = false;
                    }
                };
                
                const formatTime = (isoString) => {
                    if (!isoString) return '';
                    const date = new Date(isoString);
                    return date.toLocaleTimeString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                };
                
                // Âè™Ê£ÄÊµãÂ§±Ë¥•È°πÔºàÂ¶ÇÊûúÂ§±Ë¥•È°πÂåÖÂê´1ÔºåÂàôÂÖ®ÈáèÊ£ÄÊµãÔºâ
                const retryFailed = () => {
                    if (!result.value || !result.value.failed) return;
                    const failedKeys = Object.keys(result.value.failed);
                    // Â¶ÇÊûúÂ§±Ë¥•È°πÂåÖÂê´È°πÁõÆ1ÔºàËΩ¶Êú∫Áä∂ÊÄÅÔºâÔºåÂàôÂêØÂä®ÂÖ®ÈáèÊ£ÄÊµã
                    if (failedKeys.includes('1')) {
                        runCheck('');
                    } else {
                        const failedIds = failedKeys.join(',');
                        if (failedIds) {
                            runCheck(failedIds);
                        }
                    }
                };
                
                // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑Âèñ‰∏äÊ¨°ÁªìÊûú
                fetch('/api/status')
                    .then(r => r.json())
                    .then(data => {
                        if (data.last_result) {
                            result.value = data.last_result;
                            lastCheckTime.value = data.last_check_time;
                        }
                        if (data.is_checking) {
                            isChecking.value = true;
                            // ËΩÆËØ¢Ê£ÄÊü•Áä∂ÊÄÅ
                            const poll = setInterval(async () => {
                                const r = await fetch('/api/status').then(r => r.json());
                                if (!r.is_checking) {
                                    clearInterval(poll);
                                    isChecking.value = false;
                                    if (r.last_result) {
                                        result.value = r.last_result;
                                        lastCheckTime.value = r.last_check_time;
                                    }
                                }
                            }, 2000);
                        }
                    })
                    .catch(() => {});
                
                return {
                    isChecking,
                    result,
                    error,
                    lastCheckTime,
                    selectedItems,
                    shortcuts,
                    statusClass,
                    statusText,
                    passedCount,
                    failedCount,
                    passedItems,
                    failedItems,
                    selectShortcut,
                    runCheck,
                    retryFailed,
                    formatTime,
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
